<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Follow the Rabbit ğŸ‡ </title>

  <link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
  <link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null" href="https://unpkg.com/normalize.css@8.0.0/normalize.css">
  <link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null" href="https://unpkg.com/milligram@1.3.0/dist/milligram.min.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
  
</head>

<body>

  <main class="wrapper" style="padding-top:2em">

    <section class="container" id="demo-content" align="center">
      <label>è«‹æƒææ¬²çµ„éšŠå°è±¡çš„QR-Code</label>
      <div>
        <video id="video" width="300" height="300" style="border: 1px solid gray"></video>
      </div>
      <div>
        <a class="button" id="resetButton">é‡æ–°æƒæ</a>
      </div>

    </section>
  </main>
  
  <script type="text/javascript">
    
    function decodeOnce(codeReader, selectedDeviceId, leader, liff) {
        codeReader.decodeFromInputVideoDevice(selectedDeviceId, 'video').then((result) => {
        console.log(result)

        $.ajax({
            type: 'POST',
            url:"/team",
            data:JSON.stringify({'id':result.text,'leader':leader}),  //è½‰åŒ–å­—ä¸² 
            contentType: 'application/json; charset=UTF-8',
            success:function(data){ //æˆåŠŸçš„è©±ï¼Œå¾—åˆ°è¨Šæ¯
                if (data == 'ALREADY'){
                    var retVal = confirm("å°æ–¹å·²æœ‰æ‰€å±¬éšŠä¼ã€‚");
                }
                else if (data == 'ERR'){
                    var retVal = confirm("QR-Codeæœ‰èª¤ï¼Œè«‹æƒææ¬²çµ„éšŠä¹‹æˆå“¡ID QR-Codeã€‚\nï¼ˆè«‹è¢«çµ„éšŠæˆå“¡é»æ“ŠLINEé¸å–®ã€ŒéŠæˆ²ç‹€æ…‹ã€å³å¯çœ‹åˆ°ID QR-Code");
                }
                else if (data == 'EARLY'){
                    var retVal = confirm("éšŠå“¡å°šæœªé–‹å•Ÿã€Šå…ƒå®‡å®™æ‹“è’ç‰›ä»”ã€‹ï¼Œè«‹å¾Lineä¸‹æ–¹é¸å–®ã€Œé–‹å•ŸéŠæˆ²ã€ã€‚");   
                }
                else if (data == 'TEAM_FULL'){
                    var retVal = confirm("æ‚¨çš„éšŠä¼å·²æ»¿ä¸‰äººï¼Œè«‹é–‹å§‹å°‹æ‰¾æ¨™é¶ã€å°„æ“Šç©åˆ†ã€‚");
                    liff.openWindow({
                    // uriï¼šè¦é–‹å•Ÿçš„ç¶²å€
                        url: 'https://line.me/R/ti/p/%40302ajjlz'
                    });
                }
                else if (data == 'FINISH'){
                    var retVal = confirm("æ‚¨å·²å®Œæˆã€Šå…ƒå®‡å®™æ‹“è’ä¹‹è·¯ã€‹ï¼Œè«‹ç”±Lineé¸å–®ã€Œé–‹å•ŸéŠæˆ²ã€é€²è¡Œå…¶ä»–ä»»å‹™æ”¯ç·šã€‚")
                
                    liff.openWindow({
                    // uriï¼šè¦é–‹å•Ÿçš„ç¶²å€
                        url: 'https://line.me/R/ti/p/%40302ajjlz'
                    });
                }
                else if (data == 'OK'){
                    confirm("å·²å®Œæˆçµ„éšŠï¼Œè«‹é–‹å§‹å°‹æ‰¾æ¨™é¶ã€å°„æ“Šç©åˆ†ã€‚");
                    liff.openWindow({
                    // uriï¼šè¦é–‹å•Ÿçš„ç¶²å€
                        url: 'https://line.me/R/ti/p/%40302ajjlz'
                    });
                }
                else if (data == 'be_ALREADY'){
                    confirm("å°æ–¹éšŠä¼å·²æ»¿3äººï¼Œè«‹å¦æ‰¾å…¶ä»–äººé€²è¡Œçµ„éšŠã€‚");
                }
                else if (data == 'be_OK'){
                    confirm("æ‚¨å·²æˆåŠŸåŠ å…¥éšŠä¼ï¼Œè«‹é–‹å§‹å°‹æ‰¾æ¨™é¶ã€å°„æ“Šç©åˆ†ã€‚");
                    liff.openWindow({
                    // uriï¼šè¦é–‹å•Ÿçš„ç¶²å€
                        url: 'https://line.me/R/ti/p/%40302ajjlz'
                    });
                }
                else{
                    var retVal = confirm("å·²æˆåŠŸåŠ å…¥éšŠä¼ï¼Œç›®å‰éšŠä¼:2äººï¼Œå°šå·®1äººå³å¯é–‹å§‹å°„æ“Šã€‚");
                    liff.openWindow({
                    // uriï¼šè¦é–‹å•Ÿçš„ç¶²å€
                        url: 'https://line.me/R/ti/p/%40302ajjlz'
                    });
        
                }
            
            }
        });
          
      }).catch((err) => {
        console.error(err)
        
      })
    }
    
    document.getElementById('resetButton').addEventListener('click', () => {
        window.location.reload();
    })
    
    window.addEventListener('load', function () {
      let selectedDeviceId;
      const codeReader = new ZXing.BrowserQRCodeReader()
      console.log('code reader initialized')
      
      codeReader.getVideoInputDevices()
        .then((videoInputDevices) => {
          selectedDeviceId = videoInputDevices[0].deviceId
          liff.init({
              liffId: '1656942328-B5drm8nV' // Use own liffId 
          })
          .then(() => {
              // Start to use liff's api
              liff.getProfile().then(function (profile) {
                decodeOnce(codeReader, selectedDeviceId, profile.userId, liff);
              //liff.closeWindow();
              }).catch((err) => {
              // Error happens during initialization
                  console.log(err.code, err.message);
              });
          }).catch((err) => {
              // Error happens during initialization
              console.log(err.code, err.message);
          });
          
          
        })
        .catch((err) => {
          console.error(err)
        });
    });
    
    
    
    
  </script>

</body>

</html>